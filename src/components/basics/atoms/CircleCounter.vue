<template>
    <div class="countCircle1">
        <div class="circle-body">
            <div class="innerCircle">
                <div>
                    <span class="card-number"></span>
                    <span class="card-text">v1</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1" data-number="60" data-duration="2000">
        <div class="circle-body">
            <div class="innerCircle">
                <img src="https://placehold.it/400x400" />
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1 v2" data-number="70" data-duration="500">
        <div class="circle-wrapper">
            <svg viewbox="0 0 36 36">
                <path class="fill-circle"
                      stroke-dasharray="100,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <div class="circle-body">
            <div class="innerCircle">
                <img src="https://placehold.it/400x400" />
            </div>
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v2</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1 v2 inner" data-number="70" data-duration="500">
        <div class="circle-wrapper">
            <svg viewbox="0 0 36 36">
                <path class="fill-circle"
                      stroke-dasharray="100,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <div class="circle-body">
            <div class="innerCircle">
                <img src="https://placehold.it/400x400" />
            </div>
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v2 inner</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1 v2 inner custom-color-1" data-number="70" data-duration="500">
        <div class="circle-wrapper">
            <svg viewbox="0 0 36 36">
                <path class="fill-circle"
                      stroke-dasharray="100,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <div class="circle-body">
            <div class="innerCircle">
                <img src="https://placehold.it/400x400" />
            </div>
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v2 custom-color</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1 v2 inner custom-color-2" data-number="70" data-duration="500">
        <div class="circle-wrapper">
            <svg viewbox="0 0 36 36">
                <path class="fill-circle"
                      stroke-dasharray="100,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <div class="circle-body">
            <div class="innerCircle">
                <img src="https://placehold.it/400x400" />
            </div>
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v2 custom-color</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>

    <div class="countCircle1 mini" data-number="20" data-duration="2000">
        <div class="circle-body">
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v1 mini</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <span class="card-number">0</span>
        <span class="card-text">outer</span>
    </div>

    <div class="countCircle1 v2 mini" data-number="20" data-duration="2000">
        <div class="circle-body">
            <div class="innerCircle">
                <div>
                    <span class="card-number">0</span>
                    <span class="card-text">v1 mini</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
        <span class="card-number">0</span>
        <span class="card-text">outer</span>
    </div>

    <div id="fantasy" class="countCircle1 v2 fantasy-color">
        <div class="circle-body">
            <div class="innerCircle">
                <div>
                    <span class="card-number"></span>
                    <span class="card-text">Power</span>
                </div>
            </div>
            <svg viewbox="0 0 36 36">
                <path class="bg-circle"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="fill-circle"
                      stroke-dasharray="0,100"
                      d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>
</template>

<script lang="ts">
// https://vue-ellipse-progress-demo.netlify.app/#/
import { defineComponent } from "vue";
/*
const isValidNumber = (prop) => prop !== undefined && prop !== "" && prop !== null && !Number.isNaN(parseFloat(prop));
const animationParser = (animation) => {
    const animationConfig = animation.trim().split(" ");
    return {
        type: animationConfig[0],
        duration: isValidNumber(animationConfig[1]) ? parseFloat(animationConfig[1]) : 1000,
        delay: isValidNumber(animationConfig[2]) ? parseFloat(animationConfig[2]) : 400,
    };
};
*/

export default defineComponent({
    name: "CircleCounter",
/*
    data: () => {
        return {
            start: 0,
            startTime: 0,
            currentValue: 0,
            raf: null,
            previousCountStepValue: 0
        }
    },

    watch: {
        value() {
            this.start = this.currentValue;
            this.reset();
            this.raf = requestAnimationFrame(this.count);
        },
    },

    props: {
        value: {
            type: [Number, String],
            required: true,
        },
        duration: {
            type: Number,
            default: () => {
                return 500;
            }
        },

        TODOstart: {
            type: Number,
            default: () => {
                return 0;
            }
        },
        TODOend: {
            type: Number,
            default: () => {
                return 100;
            }
        }
    },

    computed: {
        end() {
            return parseFloat(this.value.toString().replace(",", "."));
        },
        difference() {
            return Math.abs(this.end - this.start);
        },
        oneStepDifference() {
            return this.duration === 0 ? this.difference : this.difference / this.duration;
        },
        delimiter() {
            return this.value.toString().search(",") >= 0 ? "," : ".";
        },
        formattedValue() {
            return this.currentValue.toFixed(this.countDecimals()).replace(".", this.delimiter);
        },
        delay() {
            return animationParser(this.animation).delay;
        },
        duration() {
            return animationParser(this.animation).duration;
        },
        counterProps() {
            return {
                currentValue: parseFloat(this.formattedValue),
                currentFormattedValue: this.formattedValue,
                currentRawValue: this.currentValue,
                duration: this.duration,
                previousCountStepValue: this.previousCountStepValue,
                start: this.start,
                end: this.end,
                difference: this.difference,
                oneStepDifference: this.oneStepDifference,
                startTime: this.startTime,
                elapsed: 0,
            };
        },
    },

    methods: {
        countDecimals() {
            if (this.value % 1 === 0) return 0;
            return this.value.toString().split(this.delimiter)[1].length;
        },
        count(timeStamp) {
            if (!this.startTime) {
                this.startTime = timeStamp;
            }
            const elapsed = timeStamp - this.startTime;
            if (this.end >= this.start) {
                this.countUp(elapsed);
            } else {
                this.countDown(elapsed);
            }
            if (elapsed < this.duration && this.difference > 0.1) {
                cancelAnimationFrame(this.raf);
                this.raf = requestAnimationFrame(this.count);
            }
            if (elapsed >= this.duration) {
                this.currentValue = this.end;
                this.reset();
            }
        },
        countDown(elapsed) {
            const decreaseValue = Math.min(this.oneStepDifference * (elapsed || 1), this.difference);
            this.currentValue -= decreaseValue - this.previousCountStepValue;
            this.previousCountStepValue = decreaseValue;
        },
        countUp(elapsed) {
            const increaseValue = Math.min(this.oneStepDifference * (elapsed || 1), this.difference);
            this.currentValue += increaseValue - this.previousCountStepValue;
            this.previousCountStepValue = increaseValue;
        },
        reset() {
            this.startTime = 0;
            this.previousCountStepValue = 0;
            cancelAnimationFrame(this.raf);
        },
    },

    mounted() {
        if (!this.loading) {
            setTimeout(() => {
                this.raf = requestAnimationFrame(this.count);
            }, this.delay);
        } else {
            this.raf = requestAnimationFrame(this.count);
        }
    },
*/
});

/*
    var counter = $(this).find(".card-number");
    var circle = $(this).find(".circle-body .fill-circle");
    //number
    if(counter.length){
        $({count: settings.start}).animate({count: settings.end}, {
            duration: settings.duration,
            easing: settings.easing,
            step: function() {
                var mathCount = Math.ceil(this.count);
                counter.text(mathCount);
            },
            complete: settings.complete
        });
    }
    //circle
    circle.css("animation-duration",(settings.duration/1000)+"s").attr("stroke-dasharray",settings.end+",100");
*/
</script>

<style lang="scss">
$primary-color: #ff00ff;
$secondary-color: #00ff00;
$countCircle1-strokewidth: 5% !default;
$countCircle1-animationduration: 1s !default;
$white: #fff;

.countCircle1{
    max-width: 250px;	//TODO solo per maggior chiarezza
    position:relative;
    background-color: transparent !important;
    z-index: 1;
    .circle-wrapper,
    .circle-body{
        svg{
            path{
                &.fill-circle {
                    stroke: $primary-color;
                    stroke-width: $countCircle1-strokewidth;
                    fill: none;
                    //stroke-dasharray: 40 100, // 40=numero che vogliamo, 100 obbligatorio
                    animation-name: countCircle1_a;
                    animation-timing-function: ease-out;
                    animation-fill-mode: forwards;
                    animation-duration: $countCircle1-animationduration/2;
                }
            }
        }
    }
    .circle-wrapper{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        z-index: -1;
        width:110%;
        height:110%;
    }
    .circle-body{
        position:relative;
        .innerCircle{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width:90%;
            height:90%;
            z-index: -2;
            text-align: center;
            overflow: hidden;
            border-radius: 50%;
            img{
                max-width: 100%;
                height: auto;
            }
            & > div{
                padding: 10%;
                span{
                    display:block;
                }
            }
        }
        svg {
            display: block;
            max-height:100%;
            max-width:100%;
            path{
                &.fill-circle,
                &.bg-circle{
                    stroke-linecap: round;
                }
                &.bg-circle {
                    stroke-width: $countCircle1-strokewidth*1.5;
                    stroke: lighten($primary-color, 40%);
                    fill:none;
                }
            }
        }
    }
    .card-text{
        font-size: 1.5em;
    }
    .card-number{
        font-size: 3em;
        line-height: 110%;
    }


    // ++++++++ VARIANTS ++++++++
    &.mini{
        .circle-body{
            svg{
                path{
                    &.bg-circle,
                    &.fill-circle {
                        stroke-width: $countCircle1-strokewidth/2;
                    }
                }
            }
        }
        .card-text{
            font-size: 1em;
        }
        .card-number{
            font-size: 2em;
            line-height: 110%;
        }
    }
    //circle wrapper inner instead of outer
    &.inner{
        .circle-wrapper{
            width:90%;
            height:90%;
        }
    }
    &.v2{
        .circle-body{
            svg{
                path{
                    &.bg-circle,
                    &.fill-circle {
                        animation-duration: $countCircle1-animationduration;
                        stroke-width: $countCircle1-strokewidth;
                    }
                    &.fill-circle{
                        animation-timing-function: cubic-bezier(1,0,0.2,1);
                    }
                }
            }
        }
        .circle-wrapper{
            svg{
                path{
                    &.fill-circle {
                        animation-duration: $countCircle1-animationduration;
                        stroke-width: $countCircle1-strokewidth;
                        stroke: lighten($primary-color, 30%);
                    }
                }
            }
        }
    }
    &.fantasy-color{
        .circle-wrapper svg path.fill-circle{
            stroke: transparent;
        }
        .circle-body{
            .innerCircle{
                animation: countCircle1_special_b 2s linear infinite alternate;
                background: linear-gradient(to bottom right, $secondary-color, $white, $primary-color);
            }
            svg path.fill-circle {
                animation: countCircle1_special_a 2s linear infinite alternate;
                stroke-dasharray: 100 100;
            }
        }
        .card-number {
            text-shadow: 0 0 20px $white, 0 0 50px $white;
        }
    }
}


.countCircle1{
    // custom color
    &.custom-color-1{
        .circle-body svg path.bg-circle{
            stroke: lighten($secondary-color, 40%);
        }
        .circle-wrapper svg path.fill-circle{
            stroke: lighten($secondary-color, 30%);
        }
        .circle-body svg path.fill-circle{
            stroke: $secondary-color
        }
    }
}

@keyframes countCircle1_a {
    0% {  stroke-dasharray: 0 100;  }
}
@keyframes countCircle1_special_a {
    0%{   stroke: $secondary-color;  }
    50%{  stroke: $white;  }
    100%{ stroke: $primary-color;  }
}
@keyframes countCircle1_special_b {
    0%  { box-shadow: 0 0 100px $secondary-color; }
    50% { box-shadow: 0 0 100px $white; }
    100%{ box-shadow: 0 0 100px $primary-color; }
}
</style>